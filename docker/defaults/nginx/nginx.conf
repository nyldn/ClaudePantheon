# ╔═══════════════════════════════════════════════════════════╗
# ║                    ClaudePantheon                         ║
# ║              nginx Reverse Proxy Configuration            ║
# ╚═══════════════════════════════════════════════════════════╝
#
# This file is copied to data/nginx/nginx.conf on first run.
# You can customize it there - changes persist across restarts.
#
# Path routing:
#   /           → PHP landing page (data/webroot/public_html/)
#   /terminal/  → ttyd web terminal (WebSocket)
#   /files/     → FileBrowser Quantum
#   /webdav/    → nginx WebDAV module (optional)
#                 Subdirectories: workspace/, webroot/, scripts/, logs/
#
# Authentication zones:
#   - webroot:  Protects / and static/PHP files
#   - internal: Protects /terminal/, /files/, /webdav/

# Load dynamic modules (Alpine nginx)
load_module /usr/lib/nginx/modules/ngx_http_dav_ext_module.so;

# Run as daemon off (foreground) - managed by start-services.sh
daemon off;

# Worker configuration
worker_processes auto;
error_log /tmp/nginx-error.log warn;
pid /tmp/nginx.pid;

events {
    worker_connections 1024;
}

http {
    # Basic settings
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Logging
    access_log /tmp/nginx-access.log;

    # Performance
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # Temp paths (writable by non-root)
    client_body_temp_path /tmp/nginx-client-body;
    proxy_temp_path /tmp/nginx-proxy;
    fastcgi_temp_path /tmp/nginx-fastcgi;
    uwsgi_temp_path /tmp/nginx-uwsgi;
    scgi_temp_path /tmp/nginx-scgi;

    # Gzip compression
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;

    # WebSocket upgrade map
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    # Hide nginx version in headers and error pages
    server_tokens off;

    # Rate limiting zone for authentication endpoints
    limit_req_zone $binary_remote_addr zone=auth:10m rate=5r/s;

    server {
        listen 7681;
        server_name _;

        # ── Security Headers ──
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;

        # Document root for PHP/static files
        root /app/data/webroot/public_html;
        index index.php index.html;

        # Custom 404 error page (Catppuccin-themed)
        error_page 404 /404.php;

        # ─────────────────────────────────────────────────────────
        # WEBROOT ZONE (/, /public_html/*)
        # Protected by WEBROOT_AUTH + WEBROOT_CREDENTIAL
        # ─────────────────────────────────────────────────────────

        # Landing page and static files
        location / {
            # AUTH_WEBROOT_PLACEHOLDER - replaced by start-services.sh

            try_files $uri $uri/ /index.php?$query_string;
        }

        # PHP processing
        location ~ \.php$ {
            # AUTH_WEBROOT_PLACEHOLDER - replaced by start-services.sh

            fastcgi_pass 127.0.0.1:9000;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            include /etc/nginx/fastcgi_params;

            # Timeout for long-running scripts
            fastcgi_read_timeout 300;
        }

        # ─────────────────────────────────────────────────────────
        # INTERNAL ZONE (/terminal/, /files/, /webdav/)
        # Protected by INTERNAL_AUTH + INTERNAL_CREDENTIAL
        # ─────────────────────────────────────────────────────────

        # ttyd web terminal (WebSocket support required)
        location /terminal/ {
            # AUTH_INTERNAL_PLACEHOLDER - replaced by start-services.sh
            limit_req zone=auth burst=10 nodelay;

            proxy_pass http://127.0.0.1:7682/;
            proxy_http_version 1.1;

            # WebSocket headers
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;

            # Standard proxy headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Timeouts for long-lived connections
            proxy_read_timeout 86400;
            proxy_send_timeout 86400;
            proxy_connect_timeout 60;

            # Disable buffering for real-time terminal
            proxy_buffering off;
        }

        # FileBrowser Quantum
        location /files/ {
            # AUTH_INTERNAL_PLACEHOLDER - replaced by start-services.sh
            limit_req zone=auth burst=10 nodelay;

            proxy_pass http://127.0.0.1:7683;
            proxy_http_version 1.1;

            # WebSocket headers (for live updates)
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;

            # Standard proxy headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Client upload size (for file uploads)
            client_max_body_size 0;

            # Timeouts
            proxy_read_timeout 300;
            proxy_send_timeout 300;
        }

        # WebDAV (optional - enabled via ENABLE_WEBDAV)
        # Only specific directories are exposed: workspace, webroot, scripts, logs
        # Sensitive dirs (claude/, mcp/, ssh/, filebrowser/) are NOT accessible
        # WEBDAV_LOCATION_START

        # WebDAV: /webdav/workspace/
        location /webdav/workspace/ {
            # AUTH_INTERNAL_PLACEHOLDER - replaced by start-services.sh

            alias /app/data/workspace/;

            dav_methods PUT DELETE MKCOL COPY MOVE;
            dav_ext_methods PROPFIND OPTIONS LOCK UNLOCK;
            create_full_put_path on;
            dav_access user:rw group:rw all:r;
            client_max_body_size 0;

            set $destination $http_destination;
            if ($destination ~* ^https?://([^/]+)(/.*)$) {
                set $destination http://127.0.0.1:7681$2;
            }

            autoindex on;
            autoindex_exact_size off;
            autoindex_localtime on;
        }

        # WebDAV: /webdav/webroot/
        location /webdav/webroot/ {
            # AUTH_INTERNAL_PLACEHOLDER - replaced by start-services.sh

            alias /app/data/webroot/;

            dav_methods PUT DELETE MKCOL COPY MOVE;
            dav_ext_methods PROPFIND OPTIONS LOCK UNLOCK;
            create_full_put_path on;
            dav_access user:rw group:rw all:r;
            client_max_body_size 0;

            set $destination $http_destination;
            if ($destination ~* ^https?://([^/]+)(/.*)$) {
                set $destination http://127.0.0.1:7681$2;
            }

            autoindex on;
            autoindex_exact_size off;
            autoindex_localtime on;
        }

        # WebDAV: /webdav/scripts/
        location /webdav/scripts/ {
            # AUTH_INTERNAL_PLACEHOLDER - replaced by start-services.sh

            alias /app/data/scripts/;

            dav_methods PUT DELETE MKCOL COPY MOVE;
            dav_ext_methods PROPFIND OPTIONS LOCK UNLOCK;
            create_full_put_path on;
            dav_access user:rw group:rw all:r;
            client_max_body_size 0;

            set $destination $http_destination;
            if ($destination ~* ^https?://([^/]+)(/.*)$) {
                set $destination http://127.0.0.1:7681$2;
            }

            autoindex on;
            autoindex_exact_size off;
            autoindex_localtime on;
        }

        # WebDAV: /webdav/logs/
        location /webdav/logs/ {
            # AUTH_INTERNAL_PLACEHOLDER - replaced by start-services.sh

            alias /app/data/logs/;

            dav_methods PUT DELETE MKCOL COPY MOVE;
            dav_ext_methods PROPFIND OPTIONS LOCK UNLOCK;
            create_full_put_path on;
            dav_access user:rw group:rw all:r;
            client_max_body_size 0;

            set $destination $http_destination;
            if ($destination ~* ^https?://([^/]+)(/.*)$) {
                set $destination http://127.0.0.1:7681$2;
            }

            autoindex on;
            autoindex_exact_size off;
            autoindex_localtime on;
        }

        # WebDAV: root index (shows available directories)
        location = /webdav/ {
            # AUTH_INTERNAL_PLACEHOLDER - replaced by start-services.sh
            default_type text/html;
            return 200 '<!DOCTYPE html><html><body><h2>WebDAV Directories</h2><ul><li><a href="workspace/">workspace/</a></li><li><a href="webroot/">webroot/</a></li><li><a href="scripts/">scripts/</a></li><li><a href="logs/">logs/</a></li></ul></body></html>';
        }

        # WebDAV: block all other /webdav/* paths (e.g. /webdav/claude/, /webdav/mcp/)
        location /webdav/ {
            rewrite ^ /404.php break;
            fastcgi_pass 127.0.0.1:9000;
            fastcgi_param SCRIPT_FILENAME $document_root/404.php;
            fastcgi_param REQUEST_URI $request_uri;
            include /etc/nginx/fastcgi_params;
        }
        # WEBDAV_LOCATION_END

        # ─────────────────────────────────────────────────────────
        # HEALTH CHECK (no auth required)
        # ─────────────────────────────────────────────────────────
        location = /health {
            access_log off;
            default_type text/plain;
            return 200 "ok";
        }

        # ─────────────────────────────────────────────────────────
        # SECURITY
        # ─────────────────────────────────────────────────────────

        # Deny access to hidden files (except .well-known)
        location ~ /\.(?!well-known) {
            deny all;
        }

        # Deny access to sensitive files
        location ~* \.(htaccess|htpasswd|ini|log|sh|sql|conf|env)$ {
            deny all;
        }
    }
}
