# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë                    ClaudePantheon                         ‚ïë
# ‚ïë              Makefile for Docker Management               ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
#
# Convenience commands for managing the ClaudePantheon container.
# Run from the docker/ directory.
#
# USAGE:
#   make [target]
#   make help        # Show all available targets
#
# QUICK START:
#   make build       # Build the image
#   make up          # Start the container
#   make shell       # Open a shell inside
#
# MAKEFILE SYNTAX NOTES:
#   - Lines starting with @ suppress command echo
#   - $$ escapes $ for shell variables (Makefile uses $ for its own vars)
#   - Indentation MUST be tabs, not spaces
#   - .PHONY declares targets that aren't files

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# LOAD CONFIGURATION FROM .env
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# Include .env if it exists (- prefix ignores errors if missing)
-include .env

# Default data path (used by status, tree, backup, purge targets)
# Override by setting CLAUDE_DATA_PATH in .env
CLAUDE_DATA_PATH ?= ./data

.PHONY: help build up down logs shell restart clean status backup update purge rebuild dev health version tree

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# DEFAULT TARGET (runs when you just type 'make')
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
help:
	@echo ""
	@echo "üèõÔ∏è  ClaudePantheon"
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo ""
	@echo "Usage: make [target]"
	@echo ""
	@echo "Container Lifecycle:"
	@echo "  build      Build the Docker image"
	@echo "  up         Start container (detached)"
	@echo "  down       Stop container"
	@echo "  restart    Restart container"
	@echo "  rebuild    Stop, rebuild, and start"
	@echo ""
	@echo "Access & Development:"
	@echo "  shell      Open zsh shell in container"
	@echo "  logs       Follow container logs"
	@echo "  dev        Run in foreground (with logs)"
	@echo ""
	@echo "Status & Health:"
	@echo "  status     Show container status and resources"
	@echo "  health     Check if ttyd is responding"
	@echo "  version    Show Claude Code version"
	@echo "  tree       Show data directory structure"
	@echo ""
	@echo "Maintenance:"
	@echo "  backup     Backup data directory to tarball"
	@echo "  update     Update Claude Code to latest"
	@echo "  clean      Remove container and images (keeps data)"
	@echo "  purge      Remove EVERYTHING including data"
	@echo ""
	@echo "Quick start:"
	@echo "  1. make build"
	@echo "  2. make up"
	@echo "  3. Open http://localhost:7681"
	@echo ""

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# CONTAINER LIFECYCLE
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

# Build the Docker image from Dockerfile
# Rebuilds only layers that changed (Docker caching)
build:
	@echo "üèóÔ∏è  Building ClaudePantheon..."
	docker compose build

# Start container in detached mode (background)
# Creates data directory structure on first run
up:
	@echo "üöÄ Starting ClaudePantheon..."
	docker compose up -d
	@echo ""
	@echo "üèõÔ∏è  ClaudePantheon is ready!"
	@echo "   Access at: http://localhost:7681"
	@echo "   Data dir:  $(CLAUDE_DATA_PATH)"
	@echo "   Use 'make logs' to view output"

# Stop the container (preserves data)
down:
	@echo "‚èπÔ∏è  Stopping ClaudePantheon..."
	docker compose down

# Restart without rebuilding
restart:
	@echo "üîÑ Restarting ClaudePantheon..."
	docker compose restart
	@echo "‚úÖ ClaudePantheon restarted!"

# Full rebuild: stop ‚Üí build ‚Üí start
rebuild: down build up
	@echo "‚úÖ Rebuild complete!"

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# ACCESS & DEVELOPMENT
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

# Open interactive zsh shell in running container
# Requires container to be running
shell:
	@if ! docker compose ps --format '{{.State}}' claudepantheon 2>/dev/null | grep -q "running"; then \
		echo "‚ùå Container is not running. Run 'make up' first."; \
		exit 1; \
	fi
	docker compose exec claudepantheon /bin/zsh

# Follow container logs (Ctrl+C to exit)
logs:
	docker compose logs -f

# Run in foreground with logs (useful for debugging)
# Ctrl+C stops the container
dev:
	docker compose up

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# STATUS & HEALTH
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

# Show container status, data directory, and resource usage
status:
	@echo ""
	@echo "üèõÔ∏è  ClaudePantheon Status:"
	@docker compose ps
	@echo ""
	@echo "üìÅ Data Directory ($(CLAUDE_DATA_PATH)):"
	@ls -la "$(CLAUDE_DATA_PATH)" 2>/dev/null || echo "   (not yet initialized - run 'make up' first)"
	@echo ""
	@echo "üìä Resources:"
	@docker stats --no-stream claudepantheon 2>/dev/null || echo "   Container not running"

# Quick health check - tests if ttyd web terminal responds
health:
	@wget -q --spider http://localhost:7681/ && echo "‚úÖ ttyd is responding" || echo "‚ùå ttyd not responding"

# Show installed Claude Code version
version:
	@if ! docker compose ps --format '{{.State}}' claudepantheon 2>/dev/null | grep -q "running"; then \
		echo "‚ùå Container is not running. Run 'make up' first."; \
		exit 1; \
	fi
	@docker compose exec claudepantheon claude --version

# Show data directory structure (requires 'tree' command, falls back to ls)
tree:
	@echo "üìÅ Data Directory Structure ($(CLAUDE_DATA_PATH)):"
	@tree "$(CLAUDE_DATA_PATH)" 2>/dev/null || ls -laR "$(CLAUDE_DATA_PATH)"

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# MAINTENANCE
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

# Create timestamped backup of data directory
# Warns if container is running (potential inconsistency)
backup:
	@echo "üíæ Creating backup of $(CLAUDE_DATA_PATH)..."
	@if docker compose ps --format '{{.State}}' claudepantheon 2>/dev/null | grep -q "running"; then \
		echo "‚ö†Ô∏è  Warning: Container is running. Consider 'make down' first for consistent backup."; \
		read -p "Continue anyway? (y/N): " confirm; \
		[ "$$confirm" = "y" ] || [ "$$confirm" = "Y" ] || exit 0; \
	fi
	@mkdir -p backups
	@BACKUP_NAME="backup_$$(date +%Y%m%d_%H%M%S).tar.gz"; \
	tar -czf "backups/$$BACKUP_NAME" "$(CLAUDE_DATA_PATH)"; \
	echo "‚úÖ Backup created: backups/$$BACKUP_NAME"

# Update Claude Code to latest version inside container
# Native installer auto-updates, but this forces an immediate update
update:
	@if ! docker compose ps --format '{{.State}}' claudepantheon 2>/dev/null | grep -q "running"; then \
		echo "‚ùå Container is not running. Run 'make up' first."; \
		exit 1; \
	fi
	@echo "‚¨ÜÔ∏è  Updating Claude Code..."
	docker compose exec -u claude claudepantheon sh -c 'curl -fsSL https://claude.ai/install.sh | bash'
	@echo "‚úÖ Claude Code updated!"

# Remove container and locally-built images (preserves data directory)
clean:
	@echo "üßπ Cleaning up containers and images..."
	docker compose down --rmi local
	@echo "‚úÖ Cleanup complete! Data preserved in $(CLAUDE_DATA_PATH)"

# DANGEROUS: Remove everything including all data
# Requires typing 'DELETE' to confirm
purge:
	@echo ""
	@echo "‚ö†Ô∏è  WARNING: This will permanently delete:"
	@echo "   - All Claude Code session history"
	@echo "   - All workspace files"
	@echo "   - All SSH keys and configurations"
	@echo "   - Docker images"
	@echo "   - Data path: $(CLAUDE_DATA_PATH)"
	@echo ""
	@read -p "Type 'DELETE' to confirm permanent deletion: " confirm; \
	if [ "$$confirm" = "DELETE" ]; then \
		docker compose down --rmi local; \
		rm -rf "$(CLAUDE_DATA_PATH)"/*; \
		echo "‚úÖ Full purge complete!"; \
	else \
		echo "‚ùå Cancelled."; \
	fi
