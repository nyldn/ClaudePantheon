# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                    ClaudePantheon                         â•‘
# â•‘              Makefile for Docker Management               â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# Convenience commands for managing the ClaudePantheon container.
# Run from the docker/ directory.
#
# USAGE:
#   make [target]
#   make help        # Show all available targets
#
# QUICK START:
#   make build       # Build the image
#   make up          # Start the container
#   make shell       # Open a shell inside
#
# MAKEFILE SYNTAX NOTES:
#   - Lines starting with @ suppress command echo
#   - $$ escapes $ for shell variables (Makefile uses $ for its own vars)
#   - Indentation MUST be tabs, not spaces
#   - .PHONY declares targets that aren't files

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# LOAD CONFIGURATION FROM .env
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Include .env if it exists (- prefix ignores errors if missing)
-include .env

# Default data path (used by status, tree, backup, purge targets)
# Override by setting CLAUDE_DATA_PATH in .env
CLAUDE_DATA_PATH ?= ./data

.PHONY: help build up down logs shell restart clean status backup update purge rebuild dev health version tree up-files down-all files-up files-down files-logs

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# DEFAULT TARGET (runs when you just type 'make')
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
help:
	@echo ""
	@echo "ğŸ›ï¸  ClaudePantheon"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "Usage: make [target]"
	@echo ""
	@echo "Container Lifecycle:"
	@echo "  build      Build the Docker image"
	@echo "  up         Start container (detached)"
	@echo "  down       Stop container"
	@echo "  restart    Restart container"
	@echo "  rebuild    Stop, rebuild, and start"
	@echo ""
	@echo "Access & Development:"
	@echo "  shell      Open zsh shell in container"
	@echo "  logs       Follow container logs"
	@echo "  dev        Run in foreground (with logs)"
	@echo ""
	@echo "Status & Health:"
	@echo "  status     Show container status and resources"
	@echo "  health     Check if ttyd is responding"
	@echo "  version    Show Claude Code version"
	@echo "  tree       Show data directory structure"
	@echo ""
	@echo "Maintenance:"
	@echo "  backup     Backup data directory to tarball"
	@echo "  update     Update Claude Code to latest"
	@echo "  clean      Remove container and images (keeps data)"
	@echo "  purge      Remove EVERYTHING including data"
	@echo ""
	@echo "FileBrowser (optional):"
	@echo "  up-files   Start with FileBrowser enabled"
	@echo "  down-all   Stop all services including FileBrowser"
	@echo "  files-up   Start FileBrowser only"
	@echo "  files-down Stop FileBrowser only"
	@echo "  files-logs Follow FileBrowser logs"
	@echo ""
	@echo "Quick start:"
	@echo "  1. make build"
	@echo "  2. make up          (or: make up-files for FileBrowser)"
	@echo "  3. Open http://localhost:7681"
	@echo ""

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# CONTAINER LIFECYCLE
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Build the Docker image from Dockerfile
# Rebuilds only layers that changed (Docker caching)
build:
	@echo "ğŸ—ï¸  Building ClaudePantheon..."
	docker compose build

# Start container in detached mode (background)
# Creates data directory structure on first run
up:
	@echo "ğŸš€ Starting ClaudePantheon..."
	docker compose up -d
	@echo ""
	@echo "ğŸ›ï¸  ClaudePantheon is ready!"
	@echo "   Access at: http://localhost:7681"
	@echo "   Data dir:  $(CLAUDE_DATA_PATH)"
	@echo "   Use 'make logs' to view output"

# Stop the container (preserves data)
down:
	@echo "â¹ï¸  Stopping ClaudePantheon..."
	docker compose down

# Restart without rebuilding
restart:
	@echo "ğŸ”„ Restarting ClaudePantheon..."
	docker compose restart
	@echo "âœ… ClaudePantheon restarted!"

# Full rebuild: stop â†’ build â†’ start
rebuild: down build up
	@echo "âœ… Rebuild complete!"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ACCESS & DEVELOPMENT
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Open interactive zsh shell in running container
# Requires container to be running
shell:
	@if ! docker compose ps --format '{{.State}}' claudepantheon 2>/dev/null | grep -q "running"; then \
		echo "âŒ Container is not running. Run 'make up' first."; \
		exit 1; \
	fi
	docker compose exec claudepantheon /bin/zsh

# Follow container logs (Ctrl+C to exit)
logs:
	docker compose logs -f

# Run in foreground with logs (useful for debugging)
# Ctrl+C stops the container
dev:
	docker compose up

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# STATUS & HEALTH
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Show container status, data directory, and resource usage
status:
	@echo ""
	@echo "ğŸ›ï¸  ClaudePantheon Status:"
	@docker compose ps
	@echo ""
	@echo "ğŸ“ Data Directory ($(CLAUDE_DATA_PATH)):"
	@ls -la "$(CLAUDE_DATA_PATH)" 2>/dev/null || echo "   (not yet initialized - run 'make up' first)"
	@echo ""
	@echo "ğŸ“Š Resources:"
	@docker stats --no-stream claudepantheon 2>/dev/null || echo "   Container not running"

# Quick health check - tests if ttyd web terminal responds
health:
	@wget -q --spider http://localhost:7681/ && echo "âœ… ttyd is responding" || echo "âŒ ttyd not responding"

# Show installed Claude Code version
version:
	@if ! docker compose ps --format '{{.State}}' claudepantheon 2>/dev/null | grep -q "running"; then \
		echo "âŒ Container is not running. Run 'make up' first."; \
		exit 1; \
	fi
	@docker compose exec claudepantheon claude --version

# Show data directory structure (requires 'tree' command, falls back to ls)
tree:
	@echo "ğŸ“ Data Directory Structure ($(CLAUDE_DATA_PATH)):"
	@tree "$(CLAUDE_DATA_PATH)" 2>/dev/null || ls -laR "$(CLAUDE_DATA_PATH)"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# MAINTENANCE
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Create timestamped backup of data directory
# Warns if container is running (potential inconsistency)
backup:
	@echo "ğŸ’¾ Creating backup of $(CLAUDE_DATA_PATH)..."
	@if docker compose ps --format '{{.State}}' claudepantheon 2>/dev/null | grep -q "running"; then \
		echo "âš ï¸  Warning: Container is running. Consider 'make down' first for consistent backup."; \
		read -p "Continue anyway? (y/N): " confirm; \
		[ "$$confirm" = "y" ] || [ "$$confirm" = "Y" ] || exit 0; \
	fi
	@mkdir -p backups
	@BACKUP_NAME="backup_$$(date +%Y%m%d_%H%M%S).tar.gz"; \
	tar -czf "backups/$$BACKUP_NAME" "$(CLAUDE_DATA_PATH)"; \
	echo "âœ… Backup created: backups/$$BACKUP_NAME"

# Update Claude Code to latest version inside container
# Native installer auto-updates, but this forces an immediate update
update:
	@if ! docker compose ps --format '{{.State}}' claudepantheon 2>/dev/null | grep -q "running"; then \
		echo "âŒ Container is not running. Run 'make up' first."; \
		exit 1; \
	fi
	@echo "â¬†ï¸  Updating Claude Code..."
	docker compose exec -u claude claudepantheon sh -c 'curl -fsSL https://claude.ai/install.sh | bash'
	@echo "âœ… Claude Code updated!"

# Remove container and locally-built images (preserves data directory)
clean:
	@echo "ğŸ§¹ Cleaning up containers and images..."
	docker compose down --rmi local
	@echo "âœ… Cleanup complete! Data preserved in $(CLAUDE_DATA_PATH)"

# DANGEROUS: Remove everything including all data
# Requires typing 'DELETE' to confirm
purge:
	@echo ""
	@echo "âš ï¸  WARNING: This will permanently delete:"
	@echo "   - All Claude Code session history"
	@echo "   - All workspace files"
	@echo "   - All SSH keys and configurations"
	@echo "   - Docker images"
	@echo "   - Data path: $(CLAUDE_DATA_PATH)"
	@echo ""
	@read -p "Type 'DELETE' to confirm permanent deletion: " confirm; \
	if [ "$$confirm" = "DELETE" ]; then \
		docker compose --profile files down --rmi local; \
		rm -rf "$(CLAUDE_DATA_PATH)"/*; \
		echo "âœ… Full purge complete!"; \
	else \
		echo "âŒ Cancelled."; \
	fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# FILEBROWSER (Optional)
# Web-based file manager - enable with --profile files
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Start ClaudePantheon with FileBrowser enabled
up-files:
	@echo "ğŸš€ Starting ClaudePantheon with FileBrowser..."
	docker compose --profile files up -d
	@echo ""
	@echo "ğŸ›ï¸  ClaudePantheon is ready!"
	@echo "   Terminal:     http://localhost:7681"
	@echo "   File Browser: http://localhost:$${FILEBROWSER_PORT:-7682}"
	@echo "   Data dir:     $(CLAUDE_DATA_PATH)"
	@echo ""
	@echo "   FileBrowser default login: admin / admin"
	@echo "   Use 'make logs' to view output"

# Stop all services including FileBrowser
down-all:
	@echo "â¹ï¸  Stopping all services..."
	docker compose --profile files down

# Start FileBrowser only (requires claudepantheon to be running)
files-up:
	@echo "ğŸ“ Starting FileBrowser..."
	docker compose --profile files up -d filebrowser
	@echo "ğŸ“ FileBrowser: http://localhost:$${FILEBROWSER_PORT:-7682}"

# Stop FileBrowser only
files-down:
	@echo "â¹ï¸  Stopping FileBrowser..."
	docker compose --profile files stop filebrowser

# Follow FileBrowser logs
files-logs:
	docker compose --profile files logs -f filebrowser
