# ╔═══════════════════════════════════════════════════════════╗
# ║                    ClaudePantheon                         ║
# ║          Persistent Claude Code Environment               ║
# ╚═══════════════════════════════════════════════════════════╝
#
# Docker Compose configuration for ClaudePantheon container.
#
# QUICK START:
#   1. Copy .env.example to .env and configure
#   2. Run: docker compose up -d
#   3. Open: http://localhost:7681
#
# CONFIGURATION:
#   All settings are controlled via .env file (see .env.example)
#   Variables use ${VAR:-default} syntax for fallback values
#
# VOLUMES:
#   - Primary data at /app/data (configured via CLAUDE_DATA_PATH)
#   - Optional host mounts at /mounts/<name> (see volumes section)
#
# PORTS:
#   - 7681: Web terminal (ttyd)
#   - 7682: FileBrowser (optional, enable with --profile files)
#   - 2222: SSH (optional, enable via ENABLE_SSH)

version: '3.8'

services:
  claudepantheon:
    # ─────────────────────────────────────────────────────────
    # BUILD CONFIGURATION
    # ─────────────────────────────────────────────────────────
    build:
      context: .
      dockerfile: Dockerfile
      # Note: UID/GID mapping happens at runtime via entrypoint.sh, not at build time
      # This prevents conflicts with system groups when building on different platforms

    container_name: claudepantheon
    hostname: claudepantheon
    restart: unless-stopped           # Auto-restart on failure/reboot

    # ─────────────────────────────────────────────────────────
    # ENVIRONMENT VARIABLES
    # Syntax: VAR=${FROM_ENV:-default}
    # ─────────────────────────────────────────────────────────
    environment:
      # User/Group mapping - matches host user for file permissions
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}

      # Claude API authentication (or use 'claude auth login' in container)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}

      # Terminal configuration
      - TERM=xterm-256color
      - COLORTERM=truecolor

      # ttyd web terminal settings
      - TTYD_PORT=7681
      - TTYD_CREDENTIAL=${TTYD_CREDENTIAL:-}    # Format: username:password

      # Optional features
      - ENABLE_SSH=${ENABLE_SSH:-}              # Set any value to enable
      - LOG_TO_FILE=${LOG_TO_FILE:-false}       # Log to data/logs/
      - AUTO_CONTINUE=true                       # Continue last session

      # Claude Code settings
      - CLAUDE_CODE_SHELL=/bin/zsh              # Use zsh for Claude's shell commands
      - CLAUDE_BYPASS_PERMISSIONS=${CLAUDE_BYPASS_PERMISSIONS:-false}  # Skip permission prompts

      # System
      - TZ=${TZ:-Asia/Dubai}

    # ─────────────────────────────────────────────────────────
    # PORT MAPPINGS
    # Format: "host:container"
    # ─────────────────────────────────────────────────────────
    ports:
      - "7681:7681"     # ttyd web terminal - access at http://localhost:7681
      - "2222:22"       # SSH server (requires ENABLE_SSH=true)

    # ─────────────────────────────────────────────────────────
    # VOLUME MOUNTS
    # Format: host_path:container_path[:options]
    # Options: ro (read-only), rw (read-write, default)
    # ─────────────────────────────────────────────────────────
    volumes:
      # Primary data volume - ALL persistent data lives here
      # Configure path via CLAUDE_DATA_PATH in .env
      - ${CLAUDE_DATA_PATH:-/docker/appdata/claudepantheon}:/app/data

      # ┌─────────────────────────────────────────────────────────────┐
      # │  HOST DIRECTORY MOUNTS (Optional)                           │
      # │                                                             │
      # │  Mount host directories to /mounts/<name> in container      │
      # │  so Claude can access files outside the data directory.     │
      # │                                                             │
      # │  Format: /host/path:/mounts/name[:ro]                       │
      # │  - Paths must be absolute on both sides                     │
      # │  - Add :ro suffix for read-only access                      │
      # │  - Access inside container: cd /mounts/<name>               │
      # └─────────────────────────────────────────────────────────────┘
      #
      # Examples - uncomment and modify as needed:
      #
      # Home directory
      # - /home/user:/mounts/home
      #
      # External drives
      # - /media/storage:/mounts/storage
      # - /media/backup:/mounts/backup:ro       # read-only
      #
      # Project directories
      # - /home/user/projects:/mounts/projects
      # - /var/www:/mounts/www
      #
      # Docker socket (for docker-in-docker)
      # - /var/run/docker.sock:/var/run/docker.sock

    # ─────────────────────────────────────────────────────────
    # RESOURCE LIMITS
    # ─────────────────────────────────────────────────────────
    mem_limit: ${MEMORY_LIMIT:-4G}        # Hard memory limit
    memswap_limit: ${MEMORY_LIMIT:-4G}    # Swap limit (same = no swap)

    # ─────────────────────────────────────────────────────────
    # SECURITY
    # ─────────────────────────────────────────────────────────
    security_opt:
      - no-new-privileges:true    # Prevent privilege escalation

    # ─────────────────────────────────────────────────────────
    # LOGGING
    # Container logs (separate from LOG_TO_FILE app logs)
    # ─────────────────────────────────────────────────────────
    logging:
      driver: "json-file"
      options:
        max-size: "10m"           # Rotate at 10MB
        max-file: "3"             # Keep 3 rotated files

    # ─────────────────────────────────────────────────────────
    # HEALTH CHECK
    # Docker uses this to monitor container health
    # ─────────────────────────────────────────────────────────
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:7681/"]
      interval: 30s               # Check every 30 seconds
      timeout: 10s                # Fail if no response in 10s
      retries: 3                  # Unhealthy after 3 failures
      start_period: 10s           # Grace period on startup

  # ═══════════════════════════════════════════════════════════
  # FILEBROWSER QUANTUM (Optional)
  # ═══════════════════════════════════════════════════════════
  # Web-based file manager for visual file management
  #
  # Enable with:
  #   docker compose --profile files up -d
  #   make up-files
  #
  # Access at: http://localhost:7682 (or FILEBROWSER_PORT)
  # Default credentials: admin / admin
  # ───────────────────────────────────────────────────────────
  filebrowser:
    image: gtstef/filebrowser:stable-slim
    container_name: claudepantheon-files
    hostname: claudepantheon-files
    restart: unless-stopped
    profiles:
      - files                     # Only starts with --profile files

    user: "${PUID:-1000}:${PGID:-1000}"

    environment:
      - TZ=${TZ:-UTC}
      - FB_BASEURL=/

    volumes:
      # Main data directory - maps to /srv/data in FileBrowser
      - ${CLAUDE_DATA_PATH:-./data}:/srv/data

      # FileBrowser config persistence
      - ${CLAUDE_DATA_PATH:-./data}/filebrowser:/home/filebrowser/data

      # ┌─────────────────────────────────────────────────────────────┐
      # │  HOST MOUNTS - Mirror the same mounts from claudepantheon  │
      # │  to access host directories via FileBrowser                │
      # │                                                             │
      # │  Use /srv/mounts/<name> to match /mounts/<name> in Claude  │
      # └─────────────────────────────────────────────────────────────┘
      #
      # Examples - uncomment and modify to match claudepantheon mounts:
      # - /home/user:/srv/mounts/home
      # - /media/storage:/srv/mounts/storage
      # - /var/www:/srv/mounts/www:ro

    ports:
      - "${FILEBROWSER_PORT:-7682}:80"

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
