# ╔═══════════════════════════════════════════════════════════╗
# ║                    ClaudePantheon                         ║
# ║          Persistent Claude Code Environment               ║
# ╚═══════════════════════════════════════════════════════════╝
#
# Docker Compose configuration for ClaudePantheon container.
#
# QUICK START:
#   1. Copy .env.example to .env and configure
#   2. Run: docker compose up -d
#   3. Open: http://localhost:7681
#
# ARCHITECTURE (Single Port):
#   All services accessible via port 7681:
#   - /           → Landing page (PHP)
#   - /terminal/  → ttyd web terminal (Claude Code)
#   - /files/     → FileBrowser Quantum
#   - /webdav/    → WebDAV (optional)
#
# CONFIGURATION:
#   All settings are controlled via .env file (see .env.example)
#   Variables use ${VAR:-default} syntax for fallback values
#
# SECRETS (Recommended for Production):
#   For sensitive data, use Docker secrets instead of environment variables.
#   Uncomment the 'secrets:' section below and create secret files in docker/secrets/
#   Example:
#     mkdir -p docker/secrets
#     echo "sk-ant-api03-..." > docker/secrets/anthropic_api_key.txt
#     echo "admin:strongpassword" > docker/secrets/internal_credential.txt
#     chmod 600 docker/secrets/*
#
# VOLUMES:
#   - Primary data at /app/data (configured via CLAUDE_DATA_PATH)
#   - Optional host mounts at /mounts/<name> (see volumes section)

# ─────────────────────────────────────────────────────────
# SECRETS (Optional - Recommended for Production)
# Uncomment this section to use Docker secrets
# ─────────────────────────────────────────────────────────
# secrets:
#   anthropic_api_key:
#     file: ./secrets/anthropic_api_key.txt
#   internal_credential:
#     file: ./secrets/internal_credential.txt
#   webroot_credential:
#     file: ./secrets/webroot_credential.txt

services:
  claudepantheon:
    # ─────────────────────────────────────────────────────────
    # BUILD CONFIGURATION
    # ─────────────────────────────────────────────────────────
    build:
      context: .
      dockerfile: Dockerfile
      # Note: UID/GID mapping happens at runtime via entrypoint.sh, not at build time
      # This prevents conflicts with system groups when building on different platforms

    image: ghcr.io/randomsynergy17/claudepantheon:latest

    container_name: claudepantheon
    hostname: claudepantheon
    restart: unless-stopped           # Auto-restart on failure/reboot
    init: true                         # PID 1 init for zombie reaping

    # ─────────────────────────────────────────────────────────
    # ENVIRONMENT VARIABLES
    # Syntax: VAR=${FROM_ENV:-default}
    # ─────────────────────────────────────────────────────────
    environment:
      # User/Group mapping - matches host user for file permissions
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}

      # Claude API authentication (or use 'claude auth login' in container)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}

      # Terminal configuration
      - TERM=xterm-256color
      - COLORTERM=truecolor

      # ── Two-Zone Authentication ──
      # Internal zone: /terminal/, /files/, /webdav/
      - INTERNAL_AUTH=${INTERNAL_AUTH:-false}
      - INTERNAL_CREDENTIAL=${INTERNAL_CREDENTIAL:-}

      # Webroot zone: / (landing page and custom apps)
      - WEBROOT_AUTH=${WEBROOT_AUTH:-false}
      - WEBROOT_CREDENTIAL=${WEBROOT_CREDENTIAL:-}

      # Backward compatibility (maps to INTERNAL_CREDENTIAL)
      - TTYD_CREDENTIAL=${TTYD_CREDENTIAL:-}

      # ── Feature Toggles ──
      - ENABLE_FILEBROWSER=${ENABLE_FILEBROWSER:-true}
      - ENABLE_WEBDAV=${ENABLE_WEBDAV:-false}
      - ENABLE_RCLONE=${ENABLE_RCLONE:-false}   # Remote mounts (requires FUSE - see below)

      # Optional features
      - ENABLE_SSH=${ENABLE_SSH:-false}          # Set to 'true' to enable SSH server
      - LOG_TO_FILE=${LOG_TO_FILE:-false}       # Log to data/logs/
      # Claude Code settings
      - CLAUDE_CODE_SHELL=/bin/zsh              # Use zsh for Claude's shell commands
      - CLAUDE_BYPASS_PERMISSIONS=${CLAUDE_BYPASS_PERMISSIONS:-false}  # Skip permission prompts

      # System
      - TZ=${TZ:-UTC}

    # ─────────────────────────────────────────────────────────
    # PORT MAPPINGS
    # Single port architecture - nginx reverse proxy
    # ─────────────────────────────────────────────────────────
    ports:
      - "7681:7681"     # All services via nginx (/, /terminal/, /files/, /webdav/)
      - "2222:22"       # SSH server (requires ENABLE_SSH=true)

    # ─────────────────────────────────────────────────────────
    # VOLUME MOUNTS
    # Format: host_path:container_path[:options]
    # Options: ro (read-only), rw (read-write, default)
    # ─────────────────────────────────────────────────────────
    volumes:
      # Primary data volume - ALL persistent data lives here
      # Configure path via CLAUDE_DATA_PATH in .env
      - ${CLAUDE_DATA_PATH:-/docker/appdata/claudepantheon}:/app/data

      # ┌─────────────────────────────────────────────────────────────┐
      # │  HOST DIRECTORY MOUNTS (Optional)                           │
      # │                                                             │
      # │  Mount host directories to /mounts/<name> in container      │
      # │  so Claude can access files outside the data directory.     │
      # │                                                             │
      # │  Format: /host/path:/mounts/name[:ro]                       │
      # │  - Paths must be absolute on both sides                     │
      # │  - Add :ro suffix for read-only access                      │
      # │  - Access inside container: cd /mounts/<name>               │
      # └─────────────────────────────────────────────────────────────┘
      #
      # Examples - uncomment and modify as needed:
      #
      # Home directory
      # - /home/user:/mounts/home
      #
      # External drives
      # - /media/storage:/mounts/storage
      # - /media/backup:/mounts/backup:ro       # read-only
      #
      # Project directories
      # - /home/user/projects:/mounts/projects
      # - /var/www:/mounts/www
      #
      # Docker socket (for docker-in-docker)
      # - /var/run/docker.sock:/var/run/docker.sock

    # ─────────────────────────────────────────────────────────
    # FUSE SUPPORT (Required for rclone remote mounts)
    # To enable ALL THREE of these + set ENABLE_RCLONE=true in .env:
    #   1. Uncomment devices + cap_add below
    #   2. Uncomment apparmor:unconfined in SECURITY section below
    #   3. make rebuild
    # ─────────────────────────────────────────────────────────
    # devices:
    #   - /dev/fuse
    # cap_add:
    #   - SYS_ADMIN

    # ─────────────────────────────────────────────────────────
    # RESOURCE LIMITS
    # ─────────────────────────────────────────────────────────
    mem_limit: ${MEMORY_LIMIT:-4G}        # Hard memory limit
    memswap_limit: ${MEMORY_LIMIT:-4G}    # Swap limit (same = no swap)

    # ─────────────────────────────────────────────────────────
    # SECURITY
    # ─────────────────────────────────────────────────────────
    security_opt:
      - no-new-privileges:true    # Prevent privilege escalation
      # - apparmor:unconfined     # FUSE/rclone: step 2 of 3 (uncomment with devices + cap_add above)

    # ─────────────────────────────────────────────────────────
    # LOGGING
    # Container logs (separate from LOG_TO_FILE app logs)
    # ─────────────────────────────────────────────────────────
    logging:
      driver: "json-file"
      options:
        max-size: "10m"           # Rotate at 10MB
        max-file: "3"             # Keep 3 rotated files

    # ─────────────────────────────────────────────────────────
    # HEALTH CHECK
    # Docker uses this to monitor container health
    # ─────────────────────────────────────────────────────────
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:7681/health"]
      interval: 30s               # Check every 30 seconds
      timeout: 10s                # Fail if no response in 10s
      retries: 3                  # Unhealthy after 3 failures
      start_period: 10s           # Grace period on startup

    # ─────────────────────────────────────────────────────────
    # SECRETS (Optional)
    # Uncomment to mount Docker secrets into /run/secrets/
    # ─────────────────────────────────────────────────────────
    # secrets:
    #   - anthropic_api_key
    #   - internal_credential
    #   - webroot_credential
